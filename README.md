# Risk-Aware Scene Sampling for Dynamic Assurance of Autonomous Systems

This repo has the steps to run the scene generation with the samplers as discussed in the paper. We demonstrate our approach using the CARLA Autonomous Driving Challenge https://leaderboard.carla.org/

<p align="center">
   <img src="https://github.com/Shreyasramakrishna90/AutomatedAssuranceFramework/blob/main/figures/workflow4-1.png" align="center" width="800" height="400">
</p>


## Downloads

1. You will also need to install CARLA 0.9.9, along with the additional maps.
See [link](https://github.com/carla-simulator/carla/releases/tag/0.9.9) for more instructions.

2. Download the LEC weights from [here](https://vanderbilt365-my.sharepoint.com/:u:/g/personal/shreyas_ramakrishna_vanderbilt_edu/Eaq1ptU-YJJPrqmEYUK_dx8Bad2KqhVQZJkKwngWnuMWRA?e=U3dtyf). The LEC model architecture was taken from [Learning By Cheating](https://github.com/bradyz/2020_CARLA_challenge)

Save the model.ckpt file to carla-challange/carla_project folder. 

3. Download the trained B-VAE assurance monitor weights from [here](https://vanderbilt365-my.sharepoint.com/:u:/g/personal/shreyas_ramakrishna_vanderbilt_edu/EbB6W8s1XgFJg0Uv762w3v0BuAi7pOrYPZOnbmhHBlEKVQ?e=bOy4Rm)

Unzip and save the weights to carla-challange/leaderboard/team_code/detector_code/ood_detector_weights

## Setup Virtual Environment

To run the scene generation workflow with CARLA, clone this repo.

```bash
git clone https://github.com/Shreyasramakrishna90/Resonate-Dynamic-Risk
```
Then, create a conda environment to run the experiments. 

```
To run this setup first create a virtual environment with python 3.7
conda create -n iccps python=3.7
cd ${repo}  # Enter into this repo
python3 -m pip install -r requirements.txt
```

# Running the Carla setup 

Run the simulator using the following command in one terminal. 

```bash
./CarlaUE4.sh -quality-level=Epic -world-port=3000 -resx=800 -resy=600 -opengl
```
In another terminal activate the virtual environment and run the following command.

```bash
conda activate iccps
./run_agent.sh n    #where n is the number of scenes to be generated. If not selected, 2 scenes will be generated by default.
```
This should start running the carla setup with the default random sampler. 

# Scene Generation & Samplers
We use a scenario description DSML written in [textX](https://textx.github.io/textX/stable/) to generate different temporal scene parameters (weather parameters, time-of-day,traffic density), spatial scene parameters (road segments) and agent sensor faults. These variables and samplers can be selected using the scene specification file ***carla-challange/sdl/scene/scene_description.yml***

# Samplers

The goal of this work is to test different samplers for sequential scene generation. We have integrated and the user can select from the following samplers.

1. **Manual Sampler** - The user needs to specify the scene parameters if they choose this option.
2. **Random Sampler** - A random sampler is set up, which takes in the parameters that the user wants to sample. The other parameters will take a default value.
3. **Grid Sampler** - A grid sampler is set up to search across all the scene parameter samples within their value ranges.
4. **Halton Samppler** - Halton sampler is used to draw the scene sample parameters.
5. **Random Neighborhood Search** - The sampler executes the sequenctial-search strategy discussed in the paper.
6. **Guided Bayesian Optimization** - The sampler extends the conventional Bayesian Optimization sampler with sampling rules and uses them for sampling the high-risk scenes. 


## References

The experiments in this work was built using these two works.


1. ReSonAte: A Runtime Risk Assessment Framework for Autonomous Systems [paper](https://arxiv.org/abs/2102.09419)

2. Learning By Cheating [paper](https://arxiv.org/abs/1912.12294)




